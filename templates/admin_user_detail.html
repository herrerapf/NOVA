{% extends "base.html" %}
{% block title %}Admin - {{ user.nombre }}{% endblock %}
{% block content %}
  <h2>Usuario: {{ user.nombre }} — {{ user.client_id }}</h2>
  <p>Correo: {{ user.email }}</p>
  <p>Registrado: {{ user.created_at.strftime('%Y-%m-%d') }}</p>

  <section class="card" style="margin-top:12px;">
    <h3>Suscripción</h3>

    {% if user.subscription_date %}
      <p><strong>Fecha de pago:</strong> {{ user.subscription_date.strftime('%Y-%m-%d') }}</p>
    {% endif %}

    {% if user.subscription_days is not none %}
      <p><strong>Duración (días):</strong> {{ user.subscription_days }}</p>
    {% endif %}

    {% if days_remaining is not none %}
      <p><strong>Días restantes:</strong> {{ days_remaining }}</p>
    {% endif %}

    {% if days_remaining is none or days_remaining == 0 %}
      <form method="post" action="{{ url_for('admin_user_update_subscription', user_id=user.id) }}">
        <label>Fecha de pago</label>
        <input type="date" name="fecha_pago" required value="{{ user.subscription_date.strftime('%Y-%m-%d') if user.subscription_date else '' }}">
        <label>Días (duración)</label>
        <input type="number" name="dias" min="1" required value="{{ user.subscription_days if user.subscription_days is not none else 30 }}">
        <p style="margin-top:12px;">
          <button type="submit" class="btn">Guardar / Renovar suscripción</button>
        </p>
      </form>
    {% else %}
      <p class="small">La suscripción está activa.</p>
      <form method="post" action="{{ url_for('admin_user_update_subscription', user_id=user.id) }}">
        <input type="hidden" name="fecha_pago" value="{{ user.subscription_date.strftime('%Y-%m-%d') if user.subscription_date else '' }}">
        <input type="hidden" name="dias" value="{{ user.subscription_days if user.subscription_days is not none else 30 }}">
        <p style="margin-top:12px;">
          <button type="submit" class="btn ghost">Renovar suscripción (mantener condiciones)</button>
        </p>
      </form>
    {% endif %}
  </section>

  <div style="margin-top:14px;">
    <a class="btn" href="{{ url_for('admin_create_routine', user_id=user.id) }}">Crear nueva rutina</a>

    <form method="post" action="{{ url_for('admin_user_delete', user_id=user.id) }}" style="display:inline" onsubmit="return confirm('Eliminar usuario? Esto borrará sus rutinas.')">
      <button type="submit" class="btn danger">Eliminar usuario</button>
    </form>
  </div>

  <h3 style="margin-top:20px">Rutinas existentes</h3>
  {% if routines %}
    <ul class="cards" style="list-style:none; padding:0;">
      {% for r in routines %}
        <li class="card">
          <h4>{{ r.titulo }}</h4>
          <p class="meta">Creada: {{ r.fecha_creacion.strftime('%Y-%m-%d %H:%M') }}</p>
          <p>{{ r.descripcion[:300] }}{% if r.descripcion|length > 300 %}...{% endif %}</p>

          <!-- ELIMINADO BOTÓN EDITAR RUTINA -->
          <p>
            <form style="display:inline" method="post" action="{{ url_for('admin_delete_routine', rid=r.id) }}" onsubmit="return confirm('Eliminar rutina?')">
              <button class="btn danger small" type="submit">Eliminar</button>
            </form>
          </p>

        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p>Este usuario no tiene rutinas.</p>
  {% endif %}
{% endblock %}